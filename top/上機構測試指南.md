# 上機構測試指南（micro-ROS WiFi/UDP）

## 0. 前置條件
- 板子已燒錄 `Up_control2.ino`，`set_microros_wifi_transports(SSID, 密碼, 主機IP, 2024)` 已填正確，與主機同網段（2.4G）。
- 主機已安裝並編譯好 `ros2_ws` 與 `microros_ws`。
- 查主機 IPv4（選與板子同網段的 IP）：
  ```bash
  hostname -I               # 取第一個 192.168.x.x 或 10.x.x.x
  ip -4 a | grep inet       # 亦可用此查看
  ```
  在 `set_microros_wifi_transports` 第三個參數填此 IP，Port 保持 2024。

## 1. 啟動（若尚未啟）
```bash
cd ~/114/top
./start_top.sh
```
會啟動：UDP Agent (port 2024) + 鍵盤橋接 (/keyboard_control -> /keyboard_input)。

## 2. 確認 UDP Agent 有跑
```bash
ps -ef | grep micro_ros_agent | grep udp4
ss -tuln | grep 2024
```
看到 micro_ros_agent udp4 進程，且 0.0.0.0:2024/udp 在 LISTEN 即正常。

## 3. 載入 ROS 環境（新終端）
```bash
cd ~/114/top
source ../ros2_ws/install/local_setup.bash
source ../microros_ws/install/local_setup.bash
```

## 4. 確認 Agent 節點存在
```bash
ros2 node list | grep micro_ros_agent
```
有 `/micro_ros_agent` 即代表 Agent 已被 ROS2 看到。

## 5. 確認板子是否連上（需上電且 WiFi 指向主機 IP:2024）
```bash
ros2 topic list | grep top_base
ros2 topic echo /top_base_Coordinates
```
若有看到座標心跳字串（每秒一次），表示板子已連上並在發布。

## 6. 指令回路測試
```bash
ros2 topic pub /keyboard_input std_msgs/msg/String "data: 'd'"
```
- 板子若有動作或座標變化，表示指令已到上機構。
- 若無反應，檢查 WiFi/Agent IP/Port 是否一致、同網段、防火牆是否擋 UDP 2024。

## 7. 關閉或重啟
- 停止：在執行 `start_top.sh` 的終端按 Ctrl+C（會停 Agent 與橋接）。
- 關閉橋接啟動：`ENABLE_KEYBOARD_BRIDGE=0 ./start_top.sh`

