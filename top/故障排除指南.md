# 上機構連接故障排除指南

## 問題：看不到 micro-ROS 節點和 topics

### 快速檢查清單

1. **Agent 是否在運行？**
   ```bash
   ps -ef | grep micro_ros_agent | grep udp4
   ```
   應該看到 Agent 進程。

2. **UDP 端口是否監聽？**
   ```bash
   ss -tuln | grep 2024
   ```
   應該看到 `udp UNCONN 0.0.0.0:2024`。

3. **Arduino 是否已上電？**
   - 確認板子 LED 有亮
   - 確認 USB 連接正常

4. **WiFi 設定是否正確？**
   - SSID: `RayG`
   - 密碼: `n6n6um7i`
   - Agent IP: `172.31.153.161`
   - Port: `2024`

---

## 詳細診斷步驟

### 步驟 1：重新啟動 Agent 並查看日誌

**停止現有的 Agent：**
```bash
pkill -f "micro_ros_agent.*udp4.*2024"
```

**重新啟動並查看即時日誌：**
```bash
cd ~/114/top
./start_top.sh
# 在另一個終端查看日誌
tail -f ~/114/top/logs/agent_*.log
```

**預期看到的訊息：**
- `[INFO] [micro_ros_agent]: Agent started` → Agent 啟動成功
- `[INFO] [micro_ros_agent]: Waiting for client...` → 等待 Arduino 連接
- `[INFO] [micro_ros_agent]: Client connected` → **Arduino 已連接！**

如果看到 `Client connected`，但 ROS 2 仍看不到節點，可能是 ROS 2 環境問題。

---

### 步驟 2：檢查 Arduino 串口監視器

**打開 Arduino IDE：**
1. 工具 → 序列埠監視器
2. 設定波特率：**115200**
3. 重新啟動 Arduino（拔插 USB 或按 Reset 按鈕）

**預期看到的訊息：**
- `WiFi connected` → WiFi 連接成功
- `IP address: xxx.xxx.xxx.xxx` → 取得 IP 地址
- `Connecting to agent at 172.31.153.161:2024` → 嘗試連接 Agent
- `Agent connected` 或類似訊息 → 連接成功

**可能的錯誤訊息：**
- `WiFi connection failed` → WiFi SSID/密碼錯誤，或不在 2.4GHz
- `Failed to connect to agent` → Agent IP/Port 錯誤，或網路不通
- `Timeout` → Agent 未啟動，或防火牆阻擋

---

### 步驟 3：確認網路設定

**檢查主機 IP：**
```bash
ip -4 a | grep inet | grep -v 127.0.0.1
```
應該看到 `172.31.153.161`。

**檢查 Arduino 與主機是否在同一網段：**
- Arduino 取得的 IP 應該是 `172.31.x.x`（與主機同網段）
- 如果 Arduino IP 是 `192.168.x.x` 或其他，表示不在同一 WiFi

**測試網路連通性（從主機測試 Arduino）：**
```bash
# 如果知道 Arduino 的 IP，可以用 ping 測試
ping -c 3 <Arduino_IP>
```

---

### 步驟 4：檢查防火牆

**檢查防火牆是否阻擋 UDP 2024：**
```bash
# Ubuntu/Debian
sudo ufw status
# 如果防火牆開啟，需要允許 UDP 2024
sudo ufw allow 2024/udp
```

**WSL2 用戶注意：**
- WSL2 的防火牆由 Windows 控制
- 需要在 Windows 防火牆中允許 UDP 2024
- 或暫時關閉 Windows 防火牆測試

---

### 步驟 5：確認啟動順序

**建議順序：**
1. **先啟動 Agent**（執行 `./start_top.sh`）
2. **再上電 Arduino**（插 USB 或按 Reset）

如果先上電 Arduino，它會嘗試連接 Agent，但 Agent 還沒啟動，會失敗。雖然 Arduino 會重試，但可能會有延遲。

---

### 步驟 6：使用診斷腳本

```bash
cd ~/114/top
./diagnose_connection.sh
```

這個腳本會自動檢查：
- Agent 進程狀態
- UDP 端口狀態
- ROS 2 節點和 topics
- 網路設定匹配

---

## 常見問題與解決方案

### Q1: Agent 在運行，但 Arduino 一直連不上

**可能原因：**
1. WiFi SSID/密碼錯誤
2. Arduino 不在 2.4GHz WiFi（部分 ESP32 不支援 5GHz）
3. Agent IP/Port 設定錯誤
4. 防火牆阻擋

**解決方法：**
1. 檢查 Arduino 串口監視器，查看錯誤訊息
2. 確認 WiFi 是 2.4GHz
3. 確認 Agent IP 與主機 IP 一致
4. 檢查防火牆設定

---

### Q2: Arduino 顯示 "WiFi connected"，但無法連接 Agent

**可能原因：**
1. Agent IP 錯誤（Arduino 設定的 IP 與主機實際 IP 不一致）
2. Agent Port 錯誤
3. Agent 未啟動
4. 網路不通（不同網段或防火牆）

**解決方法：**
1. 確認主機實際 IP：`ip -4 a | grep inet`
2. 確認 Arduino 程式碼中的 IP 與主機 IP 一致
3. 確認 Agent 正在運行：`ps -ef | grep micro_ros_agent`
4. 測試網路：`ping <Arduino_IP>`（如果知道 Arduino IP）

---

### Q3: Agent 顯示 "Client connected"，但 ROS 2 看不到節點

**可能原因：**
1. ROS 2 環境未正確載入
2. micro-ROS Agent 環境未載入
3. 節點名稱衝突

**解決方法：**
1. 重新載入環境：
   ```bash
   source ~/114/ros2_ws/install/local_setup.bash
   source ~/114/microros_ws/install/local_setup.bash
   ```
2. 檢查節點：`ros2 node list`
3. 檢查 topics：`ros2 topic list`

---

### Q4: 重新燒錄後仍無法連接

**可能原因：**
1. 程式碼未正確編譯/燒錄
2. 板子硬體問題
3. WiFi 模組問題

**解決方法：**
1. 確認編譯無錯誤
2. 確認燒錄成功
3. 檢查串口監視器，查看是否有任何輸出
4. 嘗試重新啟動板子（拔插 USB）

---

## 測試連接成功的方法

當一切正常時，您應該看到：

1. **Agent 日誌：**
   ```
   [INFO] [micro_ros_agent]: Client connected
   ```

2. **ROS 2 節點：**
   ```bash
   ros2 node list
   # 應該看到 /move_node
   ```

3. **ROS 2 Topics：**
   ```bash
   ros2 topic list | grep top_base
   # 應該看到 /top_base_Coordinates 和 /top_base_locate
   ```

4. **座標心跳：**
   ```bash
   ros2 topic echo /top_base_Coordinates
   # 應該每秒看到座標訊息
   ```

5. **指令測試：**
   ```bash
   ros2 topic pub /keyboard_input std_msgs/msg/String "data: 'd'"
   # 板子應該有動作或座標變化
   ```

---

## 需要協助？

如果以上步驟都無法解決問題，請提供：
1. Agent 日誌內容（`~/114/top/logs/agent_*.log`）
2. Arduino 串口監視器輸出
3. `./diagnose_connection.sh` 的完整輸出
4. `ros2 node list` 和 `ros2 topic list` 的輸出

